<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- jQuery first, then D3.js, then Bootstrap JS -->
    <script type="text/javascript" src="../static/js/jquery.min.js"></script>
    <script type="text/javascript" src="../static/js/d3.v6.min.js"></script>
    <link rel="stylesheet" href="../static/css/common.css">
    <script type="text/javascript" src="../static/js/haplotype-plot.js"></script>
    <script type="text/javascript" src="../static/js/utils.js"></script>
    <title>Gene Haplotypes</title>
</head>

<body>
    <header class="header">
        <h2 class="test">Gene Haplotypes</h2>
        <div class="navigation left">
            <a href="./index.html">Home</a>
            <a href="./index.html">About</a>
        </div>
    </header>
    <main class="main">
        <div id="haplotype" class="haplotype-warapper" style="display: block;">
            <div class="haplotype-control">
                <form action="/cgi-bin/hap-show.py" accept-charset="UTF-8" method="post" class="haplotype-form">
                    <input type="text" name="name" class="gene-select" id="name" placeholder="gene name"
                        data-rule="minlen:4" data-msg="Please enter at least 4 chars">
                    <input type="submit" name="commit" value="show">
                </form>
            </div>
            <div class="observablehq" dir="auto">
                <svg width="520" height="44" style="overflow: visible;">
                    <g>
                        <rect x="133" y="18" width="32" height="10" fill="white" stroke="red" style="stroke-dasharray: 4, 4; stroke-width: 1.5" ></rect>
                        <rect x="168" y="18" width="34" height="10" fill="green"></rect>
                        <rect x="203" y="18" width="34" height="10" fill="#800080"></rect>
                        <rect x="238" y="18" width="34" height="10" fill="#FFA500"></rect>
                        <circle cx="285" cy="23" r="6" fill="blue"></circle>
                        <rect x="296" y="18" width="34" height="10" fill="#00FFFF"></rect>
                        <rect x="331" y="18" width="34" height="10" fill="#FF4500"></rect>
                        <rect x="366" y="18" width="34" height="10" fill="#1E90FF"></rect>
                    </g>
                    <g transform="translate(130,28)" fill="none" font-size="10" font-family="sans-serif"
                        text-anchor="middle">
                        <g class="tick" opacity="1" transform="translate(20.5,0)">
                            <line stroke="currentColor" y2="0"></line>
                            <text fill="currentColor" y="3" dy="0.71em">DEL</text>
                        </g>
                        <g class="tick" opacity="1" transform="translate(55.5,0)">
                            <line stroke="currentColor" y2="0"></line>
                            <text fill="currentColor" y="3" dy="0.71em">INS</text>
                        </g>
                        <g class="tick" opacity="1" transform="translate(90.5,0)">
                            <line stroke="currentColor" y2="0"></line>
                            <text fill="currentColor" y="3" dy="0.71em">SVDEL</text>
                        </g>
                        <g class="tick" opacity="1" transform="translate(125.5,0)">
                            <line stroke="currentColor" y2="0"></line>
                            <text fill="currentColor" y="3" dy="0.71em">SVDUP</text>
                        </g>
                        <g class="tick" opacity="1" transform="translate(155.5,0)">
                            <line stroke="currentColor" y2="0"></line>
                            <text fill="currentColor" y="3" dy="0.71em">SNP</text>
                        </g>
                        <g class="tick" opacity="1" transform="translate(185.5,0)">
                            <line stroke="currentColor" y2="0"></line>
                            <text fill="currentColor" y="3" dy="0.71em">UP</text>
                        </g>
                        <g class="tick" opacity="1" transform="translate(220.5,0)">
                            <line stroke="currentColor" y2="0"></line>
                            <text fill="currentColor" y="3" dy="0.71em">UTR</text>
                        </g>
                        <g class="tick" opacity="1" transform="translate(253.5,0)">
                            <line stroke="currentColor" y2="0"></line>
                            <text fill="currentColor" y="3" dy="0.71em">EXON</text>
                        </g>
                        <text x="0" y="-16" fill="currentColor" text-anchor="start" font-weight="bold"
                            class="title">Variation And Gene Structure Color Distribution
                        </text>
                    </g>
                </svg>
            </div>
            <div class="haplotype-plot" dir="auto" height="540"
                style="overflow-y: scroll; cursor: pointer; margin: 17px 0;">
                <svg width="1450" id="d3-plot" class="svgs" style="background-color: #ffffff;"></svg>
            </div>
            <div class="haplotype-table">
                <div class="tbl-header">
                    <table>
                        <thead>
                            <tr>
                                <th>Block_no</th>
                                <th>Assembly</th>
                                <th>Start</th>
                                <th>End</th>
                                <th>Length</th>
                            </tr>
                        </thead>
                    </table>
                </div>
                <div class="tbl-content">
                    <table>
                        <tbody>
                            <tr>
                                <td>1</td>
                                <td>LongReach Lancer</td>
                                <td>40,000,000</td>
                                <td>485,000,000</td>
                                <td>445,000,000</td>
                            </tr>
                            <tr>
                                <td>1</td>
                                <td>Jagger</td>
                                <td>35,000,000</td>
                                <td>485,000,000</td>
                                <td>450,000,000</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>
    <footer>
        <span>这是footer</span>
    </footer>

    <script type="text/javascript">
        let containerId = "d3-plot";
        let container = document.querySelector("#d3-plot");
        let response;
        $.ajax({
            type: "GET",
            // url: "http://10.2.2.32/webapp/static/example_update1.json",
            url: "../static/example_update2.json",
            //url: "../gene_data/TraesCS2D02G079600.json",
            dataType: "json",
            contentType: "application/json; charset=utf-8",
            async: false,
            success: function (resData) {
                response = resData;
            },
            error: function (err) {
                console.log(err);
            }
        });

        function handleResData(data) {
            let temp = [];
            let geneStructure = data["gene_structure"];
            let sampleNames = data["sample_name"];
            let variation = data["variation"];
            let p3 = geneStructure["3p_UTR"]["0"];
            let p5 = geneStructure["5p_UTR"]["0"];
            let exon = geneStructure["exon"];
            let upstream = geneStructure["upstream"]["0"];
            let ori = geneStructure["ori"];
            let gene = geneStructure["gene"]["0"];
            let gs_obj = {};
            if (ori === '+') {
                gs_obj["start"] = upstream["0"] - 1;
                gs_obj["end"] = gene["1"];
                gs_obj["geneEnd"] = gene["1"];
            } else if (ori === '-') {
                gs_obj["start"] = gene["0"] - 1;
                gs_obj["end"] = upstream["1"];
                gs_obj["geneEnd"] = gene["1"];
            }

            if (+(gs_obj["start"]) > 0) {
                gs_obj["upstream"] = upstream["1"] - upstream["0"] + 1 + gs_obj["start"];
                gs_obj["5p_UTR"] = p5["1"] - p5["0"] + 1 + gs_obj["start"];
                gs_obj["3p_UTR"] = p3["1"] - p3["0"] + 1 + gs_obj["start"];
                let _exon = [];
                exon.forEach(d => {
                    _exon.push([d["0"], d["1"] + gs_obj["start"]]);

                })
                gs_obj["exon"] = _exon;
            } else {
                gs_obj["upstream"] = upstream["1"] - upstream["0"] + 1;
                gs_obj["5p_UTR"] = p5["1"] - p5["0"] + 1;
                gs_obj["exon"] = exon;
                gs_obj["3p_UTR"] = p3["1"] - p3["0"] + 1;
            }
            gs_obj["name"] = sampleNames;
            gs_obj["variation"] = variation;
            gs_obj["ori"] = ori;
            temp.push(gs_obj);
            return temp;
        }

        let data = handleResData(response);
        console.log(data);

        // 常量
        let margin = ({
            top: 50,
            right: 10,
            bottom: 10,
            left: 60
        })
        let color = ({
            ins: 'green',
            del: 'red',
            utrP5: '#FF4500',
            utrP3: '#FF4500',
            upstream: '#00FFFF',
            snp: 'blue',
            exon: '#1E90FF',
            svDup: '#FFA500',
            svDel: '#800080'
        })
        let svg = d3.select(container);
        // width="1450" height="360" 
        let width = +svg.attr("width");
        // let height = +svg.attr("height");
        let height = data[0].name.length * 50;
        svg.attr("height", height);
        let innerWidth = width - margin.left - margin.right;
        let innerHeight = height - margin.top - margin.bottom;
        let xScale, yScale;
        let lineLeft, lineRight, geneLength;
        let xScaleMax, start;
        let gsHeight = 28;
        let gsHeightMin = 15;
        let snpPosition = [];
        let _snp, graph, bindHeight, sampleNames;
        let yValue = (datum) => { return datum.name };

        const renderInit = function (data) {
            let ori = data[0].ori;
            start = data[0].start;
            geneEnd = data[0].geneEnd;
            sampleNames = data[0].name;
            if (ori === '+') {
                xScaleMax = data[0].end;
            } else if (ori === '-') {
                xScaleMax = data[0].end;
            }
            //设置坐标轴的比例尺
            xScale = d3.scaleLinear()
                //.domain([d3.min(data, xValue), d3.max(data, xValue)])
                .domain([start, xScaleMax])
                .range([0, innerWidth]).nice();

            yScale = d3.scaleBand()
                .domain(d3.map(yValue(data[0]), d => d))
                .range([0, innerHeight]);

            const g = svg.append("g")
                .attr("transform", `translate(${margin.left}, ${margin.top})`)
                .attr("id", "maingroup")

            //绘制坐标轴
            const xAxis = d3.axisTop(xScale);
            let xAxisGroup = g.append('g').call(xAxis).attr('transform', `translate(${0}, ${0})`).attr("class", "top-axis")
                .attr("text-anchor", "end");
            const yAxis = d3.axisLeft(yScale);
            g.append('g').attr("class", "sample-name").call(yAxis).attr("class", "left-axis");

            //设置Variation
            variation = data[0].variation;
            let xAxisGroupTop = g.append('g').call(xAxis).attr('transform', `translate(${0}, ${-30})`)
                .attr("text-anchor", "end");

            xAxisGroupTop.append('circle').attr("cx", xScale(2500)).attr("cy", "0")
                .attr("r", 6).attr("fill", color.snp);


            //绘制版心
            graph = g.append("g").attr("class", "map")
            bindHeight = yScale.bandwidth();

            //所有的基因柱状底色全为灰色
            let bottomColor = [];

            for (let i = 0; i < data[0].name.length; i++) {
                let bind = [start, data[0].name[i], gsHeightMin, xScaleMax]
                bottomColor.push(bind);
            }

            bottomColor.forEach(d => {
                graph.append("rect").attr("fill", 'gray').attr("class", "bc")
                    .attr("opacity", 0.6).attr("x", xScale(d[0]))
                    .attr("y", yScale(d[1]) + bindHeight / 2 - d[2] / 2).attr("height", d[2]).attr("width", xScale(d[3]));
            })

            //绘制不同基因区间的图形
            //绘制upstream
            upstream = [];
            if (ori === '+') {
                for (let i = 0; i < data[0].name.length; i++) {
                    let bind = [start, data[0].name[i], gsHeightMin, data[0].upstream]
                    upstream.push(bind);
                }
            } else if (ori === '-') {
                for (let i = 0; i < data[0].name.length; i++) {
                    let bind = [geneEnd, data[0].name[i], gsHeightMin, data[0].upstream]
                    upstream.push(bind);
                }
            }

            upstream.forEach(d => {
                graph.append("rect").attr("fill", color.upstream).attr("opacity", 1).attr("x", xScale(d[0]))
                    .attr("y", yScale(d[1]) + bindHeight / 2 - d[2] / 2).attr("height", d[2]).attr("width", xScale(d[3]))
            })

            //绘制5p_UTR
            utrP5 = [];
            for (let i = 0; i < data[0].name.length; i++) {
                let bind = [data[0].upstream - start, data[0].name[i], gsHeight, data[0]["5p_UTR"]]
                utrP5.push(bind);
            }

            utrP5.forEach(d => {
                graph.append("rect").attr("fill", color.utrP5).attr("opacity", 1).attr("x", xScale(d[0]))
                    .attr("y", yScale(d[1]) + bindHeight / 2 - d[2] / 2).attr("height", d[2]).attr("width", xScale(d[3]))
            })

            //绘制3p_UTR
            utrP3 = [];
            for (let i = 0; i < data[0].name.length; i++) {
                let bind = [geneEnd - data[0]["3p_UTR"] + start, data[0].name[i], gsHeight, data[0]["3p_UTR"]]
                utrP3.push(bind);
            }

            utrP3.forEach(d => {
                graph.append("rect").attr("fill", color.utrP3).attr("opacity", 1).attr("x", xScale(d[0]))
                    .attr("y", yScale(d[1]) + bindHeight / 2 - d[2] / 2).attr("height", d[2]).attr("width", xScale(d[3]))
            })

            //绘制exon 
            exon = [];
            for (let i = 0; i < data[0].name.length; i++) {
                let exonData = data[0].exon;
                exonData.forEach(d => {
                    let innerBind = [d[0], data[0].name[i], gsHeight, d[1] - d[0] + 1];
                    exon.push(innerBind);
                })
            }
            exon.forEach(d => {
                graph.append("rect").attr("fill", color.exon).attr("opacity", 1).attr("x", xScale(d[0]))
                    .attr("y", yScale(d[1]) + bindHeight / 2 - d[2] / 2).attr("height", d[2]).attr("width", xScale(d[3]))
            })

            //绘制INDEL插入缺失
            del = [];
            ins = [];
            INDEL = variation.INDEL;
            for (let i = 0; i < data[0].name.length; i++) {
                for (let j = 0; j < INDEL.length; j++) {
                    let item = INDEL[j];
                    if (item.type == 'DEL') {
                        if (item.stat_in_each_sample[i] == '1') {
                            let bind = [item.position, data[0].name[i], gsHeightMin, item.length + start];
                            del.push(bind);
                        }
                    } else if (item.type == 'INS') {
                        if (item.stat_in_each_sample[i] == '1') {
                            let bind = [item.position, data[0].name[i], gsHeightMin, item.length + start];
                            ins.push(bind);
                        }
                    }
                }
            }

            del.forEach(d => {
                graph.append("rect").attr("stroke", color.del).attr("fill", "white").attr("opacity", 1).attr("x", xScale(d[0]))
                    .attr("y", yScale(d[1]) + bindHeight / 2 - d[2] / 2).attr("height", d[2]).attr("width", xScale(d[3]))
                    .style("stroke-dasharray", "4, 4").style("stroke-width", '1.5');

                // top graph
                xAxisGroupTop.append('rect').attr("x", xScale(d[0])).attr("y", "-4").attr("stroke", color.del).attr("fill", "white")
                    .attr("width", xScale(d[3])).attr("height", "8").attr("text-anchor", "middle")
                    .style("stroke-dasharray", "4, 4").style("stroke-width", '1.5');
            })

            ins.forEach(d => {
                graph.append("rect").attr("fill", color.ins).attr("opacity", 1).attr("x", xScale(d[0]))
                    .attr("y", yScale(d[1]) + bindHeight / 2 - d[2] / 2).attr("height", d[2]).attr("width", xScale(d[3]));

                xAxisGroupTop.append('rect').attr("x", xScale(d[0])).attr("y", "-4").attr("fill", color.ins)
                    .attr("width", xScale(d[3])).attr("height", "8").attr("text-anchor", "middle");
            })

            //绘制sv
            svDel = [];
            svDup = [];
            SV = variation.SV;
            for (let i = 0; i < data[0].name.length; i++) {
                for (let j = 0; j < SV.length; j++) {
                    let item = SV[j];
                    if (item.type == 'DEL') {
                        if (item.stat_in_each_sample[i] == '1') {
                            let bind = [item.position, data[0].name[i], gsHeightMin, item.length + start];
                            svDel.push(bind);
                        }
                    } else if (item.type == 'DUP') {
                        if (item.stat_in_each_sample[i] == '1') {
                            let bind = [item.position, data[0].name[i], gsHeightMin, item.length + start];
                            svDup.push(bind);
                        }
                    }
                }
            }

            svDel.forEach(d => {
                graph.append("rect").attr("fill", color.svDel).attr("opacity", 1).attr("x", xScale(d[0]))
                    .attr("y", yScale(d[1]) + bindHeight / 2 - d[2]).attr("height", d[2] / 2).attr("width", xScale(d[3]));

                xAxisGroupTop.append('rect').attr("x", xScale(d[0])).attr("y", "-6").attr("fill", color.svDel)
                    .attr("width", xScale(d[3])).attr("height", "4").attr("text-anchor", "middle");
            })

            svDup.forEach(d => {
                graph.append("rect").attr("fill", color.svDup).attr("opacity", 1).attr("x", xScale(d[0]))
                    .attr("y", yScale(d[1]) + bindHeight / 2 - d[2]).attr("height", d[2] / 2).attr("width", xScale(d[3]));

                xAxisGroupTop.append('rect').attr("x", xScale(d[0])).attr("y", "-6").attr("fill", color.svDup)
                    .attr("width", xScale(d[3])).attr("height", "4").attr("text-anchor", "middle");
            })

            //绘制CN 
            _cn = [];
            CN = variation.CN;
            for (let i = 0; i < data[0].name.length; i++) {
                let text = [xScaleMax + 400, data[0].name[i], gsHeightMin, CN[i]];
                _cn.push(text);
            }

            _cn.forEach(d => {
                graph.append("text").attr("opacity", 1).attr("x", xScale(d[0]))
                    .attr("y", yScale(d[1]) + bindHeight / 2 + 10).text(d[3])
                    .attr("font-size", '1.5em').attr("text-anchor", 'middle');
            })

            //draw SNP
            _snp = [];
            SNP = variation.SNP;
            for (let i = 0; i < data[0].name.length; i++) {
                for (let j = 0; j < SNP.length; j++) {
                    let item = SNP[j];
                    let bind = [item.position, data[0].name[i], gsHeightMin, item.stat_in_each_sample[i]];
                    _snp.push(bind);
                    snpPosition.push(item.position);
                }
            }

            _snp.forEach(d => {
                graph.append("text").attr("opacity", 0).attr("x", xScale(d[0]))
                    .attr("y", yScale(d[1]) + bindHeight / 2 + 10).text(d[3]).attr("class", "snp")
                    .attr("font-size", '1em').attr("text-anchor", 'start');
            })
        }

        renderInit(data);

        let createTooltip = function (el) {
            el
                .style("position", "absolute")
                .style("pointer-events", "none")
                .style("top", 0)
                .style("opacity", 0)
                .style("background", "red")
                .style("border-radius", "5px")
                .style("box-shadow", "0 0 10px rgba(0,0,0,.25)")
                .style("padding", "10px")
                .style("line-height", "1.3")
                .style("font", "11px sans-serif")
        }

        // show text following line 
        const showText = function (xPosition, yPosition, withMouseOut) {
            let textShowDeviation = 80;
            if (withMouseOut !== undefined) {
                if (withMouseOut) {
                    svg.select("text.show-text")
                        .text("")
                        .attr("x", xPosition)
                        .attr("y", yPosition)
                }
            } else {
                svg.select("text.show-text")
                    .text(xPosition)
                    .attr("x", xPosition + textShowDeviation)
                    .attr("y", yPosition + textShowDeviation)
            }
        }
        function unique(arr) {
            return Array.from(new Set(arr));
        }
        // When the SNP mutation site is detected, the mutation information is displayed 
        const showSNPMutationInfo = function (xPosition) {
            let changeToXScale = Math.round((xPosition - lineLeft));

            let allSNP = [];
            $(".snp").each(function () {
                allSNP.push($(this).attr("x"));
            });
            let uniqueSNP = unique(allSNP);
            let changeSNP = uniqueSNP.map(item => Math.round(item));

            // snpPosition.includes(changeToXScale)
            if (changeSNP.indexOf(changeToXScale) != -1) {
                ix = changeSNP.indexOf(changeToXScale);
                currentX = uniqueSNP[ix];
                $(".snp").each(function () {
                    if ($(this).attr("x") === currentX) {
                        $(this).attr("opacity", 1)
                    } else (
                        $(this).attr("opacity", 0)
                    )
                });
            } else {
                $(".snp").each(function () {
                    $(this).attr("opacity", 0)
                });
            }
        }

        const drawLine = function () {
            lineLeft = margin.left;
            geneLength = +($(".bc").attr("width"));
            lineRight = geneLength + lineLeft;
            const tooltip = d3.select(document.createElement("div")).call(createTooltip);
            const hoverLine = svg.append("line").attr("class", "hover-line").attr("y1", 0)
                .attr("y2", height - margin.bottom).attr("stroke", "red").style("pointer-events", "none").style("opacity", 0);

            const hoverText = svg.append("svg:g").attr("class", "hover-text").append("svg:text").attr("class", "show-text")
                .attr("font-size", 16).attr("fill", "#333").text("").attr("x", 0).attr("y", 0);
            svg
                .on("mousemove", function (event) {
                    // get current mouse location, return [mouseX, mouseY]
                    let [x, y] = d3.pointer(event);

                    // draw line
                    if (x < lineLeft) {
                        hoverLine.style("opacity", 0);
                        hoverText.style("opacity", 0);
                    } else if (x >= lineLeft && x <= lineRight) {
                        hoverLine.style("opacity", 1);
                        hoverLine.attr("transform", `translate(${x}, 0)`);
                        hoverText.style("opacity", 1);
                        showText(x - lineLeft, y);
                        showSNPMutationInfo(x);
                    } else if (x > lineRight) {
                        hoverLine.style("opacity", 0);
                        hoverText.style("opacity", 0);
                    }

                    if (y < margin.top | y > height - margin.bottom) {
                        hoverText.style("opacity", 0);
                        showText(0, 0, true);
                    }

                    y += 20;
                    if (x > width / 2) x -= 100;

                    tooltip
                        .style("left", x + "px")
                        .style("top", y + "px")

                })
        }
        drawLine();
    </script>
</body>

</html>
